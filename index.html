<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AXON IMPACT</title>
    <style>
        body { background: #0d1117; color: white; font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .panel { background: #161b22; padding: 30px; border-radius: 15px; text-align: center; width: 85%; max-width: 400px; border: 1px solid #30363d; position: relative; z-index: 9999; }
        .btn { display: block; width: 100%; padding: 15px; margin: 15px 0; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; background: #238636; color: white; }
        .btn:disabled { background: #21262d; color: #484f58; cursor: not-allowed; }
        #player { width: 100%; border-radius: 10px; margin-top: 15px; }
    </style>
</head>
<body>

    <div id="registration" class="panel">
        <h2 style="color: #4CAF50;">AXON: IMPACTO üõ°Ô∏è</h2>
        <p>Ayuda a personas sin hogar y animales.</p>
        <hr border="0" style="border-top: 1px solid #30363d; margin: 20px 0;">
        <label style="cursor: pointer;">
            <input type="checkbox" id="readTerms" checked> Acepto t√©rminos.
        </label>
        <button id="startButton" class="btn">ENTRAR A MISIONES</button>
    </div>

    <div id="missionList" class="panel" style="display:none;">
        <h3>MISIONES DISPONIBLES üìã</h3>
        <button onclick="iniciarMision('dQw4w9WgXcQ', 'Misi√≥n 1')" class="btn" style="background:#2c3e50;">üìπ Tarea 1 (+10)</button>
        <button onclick="iniciarMision('7wtfhZwyrcc', 'Misi√≥n 2')" class="btn" style="background:#2c3e50;">üìπ Tarea 2 (+10)</button>
        <div style="margin-top:20px;">Monedas: <span id="coins">0</span> ü¶¥</div>
        <button id="donateButton" class="btn" style="background:#da3633;">‚ù§Ô∏è DONAR A LA CAUSA</button>
    </div>

    <div id="miniapppanel" class="panel" style="display:none;">
        <h4 id="activeTitle">Cargando...</h4>
        <div id="player"></div>
        <button id="validateCode" class="btn" style="display:none; background:#1f6feb;">‚úÖ VALIDAR TAREA</button>
        <button onclick="location.reload()" class="btn" style="background:#30363d;">‚¨ÖÔ∏è VOLVER</button>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // CONFIGURACI√ìN
        const supabaseUrl = 'https://ywkcnxhlptqagwxjnygx.supabase.co'; 
        const supabaseKey = 'sb_publishable_Pp5vR4_C_8FPhgrFItKpPQ_gt6f6z3k';
        const supabase = (typeof supabase !== 'undefined') ? supabase.createClient(supabaseUrl, supabaseKey) : null;

        let player, videoEnded = false, coins = 0;

        // --- EL ARREGLO MAESTRO ---
        // Usamos un listener de ventana para asegurar que el bot√≥n funcione s√≠ o s√≠
        window.onload = function() {
            const btnInicio = document.getElementById('startButton');
            
            btnInicio.onclick = function(e) {
                e.preventDefault();
                console.log("BOT√ìN PULSADO");
                
                // CAMBIO DE PANTALLA MANUAL E INMEDIATO
                document.getElementById('registration').style.display = 'none';
                document.getElementById('missionList').style.display = 'block';
                
                // INTENTO DE TELEGRAM
                try {
                    if (window.Telegram && window.Telegram.WebApp) {
                        window.Telegram.WebApp.expand();
                        window.Telegram.WebApp.ready();
                    }
                } catch (err) {
                    console.log("Telegram no disponible, pero la app sigue.");
                }
            };
        };

        function iniciarMision(id, titulo) {
            document.getElementById('missionList').style.display = 'none';
            document.getElementById('miniapppanel').style.display = 'block';
            document.getElementById('activeTitle').innerText = titulo;
            if (player && player.loadVideoById) player.loadVideoById(id);
        }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '200', width: '100%', videoId: 'dQw4w9WgXcQ',
                events: { 'onStateChange': (e) => {
                    if (e.data === YT.PlayerState.ENDED) {
                        videoEnded = true;
                        document.getElementById('validateCode').style.display = 'block';
                    }
                }}
            });
        }

        document.getElementById('validateCode').onclick = async () => {
            coins += 10;
            document.getElementById('coins').innerText = coins;
            alert("¬°Sumaste 10 monedas para ayudar!");
            location.reload();
        };
    </script>
</body>
</html>

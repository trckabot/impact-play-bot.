<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AXON IMPACT GLOBAL</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        :root { --primary: #2ecc71; --bg-dark: rgba(13, 17, 23, 0.9); --panel: rgba(22, 27, 34, 0.98); --text: #e6edf3; --music: #8a2be2; --video: #1f6feb; --gold: #f1c40f; --orange: #e67e22; --task: #3498db; --game: #e74c3c; }
        body, html { height: 100%; margin: 0; color: var(--text); font-family: 'Segoe UI', sans-serif; background: url('https://i.postimg.cc/pXMzbPsj/20260216-171012-0000.png') no-repeat center center fixed; background-size: cover; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .overlay-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 1; }
        .container { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; width: 100%; }
        .panel { background: var(--panel); padding: 25px; border-radius: 30px; width: 85%; max-width: 380px; text-align: center; border: 1px solid rgba(46, 204, 113, 0.3); box-shadow: 0 15px 35px rgba(0,0,0,0.8); backdrop-filter: blur(10px); max-height: 85vh; overflow-y: auto; }
        .btn { display: block; width: 100%; padding: 14px; margin: 10px 0; border: none; border-radius: 15px; font-weight: bold; cursor: pointer; color: white; transition: 0.3s; font-size: 13px; text-transform: uppercase; text-decoration: none; box-sizing: border-box; }
        .btn-green { background: var(--primary); }
        .btn-video { background: var(--video); }
        .btn-music { background: var(--music); }
        .btn-gold { background: var(--gold); color: #000; }
        .btn-yt-interact { background: #ff0000; font-size: 15px; padding: 12px; margin-bottom: 15px; }
        .btn-back { background: #333; font-size: 11px; }
        .btn-upload { background: #e67e22; }
        .screen { display: none; width: 100%; flex-direction: column; align-items: center; }
        #video-placeholder { width: 100%; aspect-ratio: 16/9; border-radius: 15px; background: #000; margin-bottom: 10px; }
        .balance-card { background: rgba(46, 204, 113, 0.1); border-radius: 15px; padding: 15px; margin-top: 15px; border: 1px dashed var(--primary); }
        input[type="text"], input[type="file"] { width: 100%; background: rgba(13, 17, 23, 0.8); color: white; border: 1px solid #30363d; border-radius: 10px; padding: 12px; margin: 8px 0; box-sizing: border-box; }
        input[type="file"] { padding: 8px; }
    </style>
</head>
<body>
    <div class="overlay-bg"></div>
    <div class="container">
        
        <div id="screenStart" class="screen" style="display: flex;">
            <img src="https://i.postimg.cc/pXMzbPsj/20260216-171012-0000.png" style="width:180px; border-radius:20px; margin-bottom:15px;">
            <div class="panel">
                <h2 style="color: var(--primary);">AXON IMPACT</h2>
                <p>Ayudando a personas necesitadas y animales con Blockchain.</p>
                <button onclick="nav('screenMenu')" class="btn btn-green">ENTRAR A MISIONES</button>
            </div>
        </div>

        <div id="screenMenu" class="screen">
            <div class="panel">
                <h3>MISIONES ACTIVAS Υ</h3>
                <button onclick="nav('folderVideo')" class="btn btn-video"> VIDEOS</button>
                <button onclick="nav('folderMusic')" class="btn btn-music"> MSICA</button>
                <button onclick="nav('folderGames')" class="btn" style="background:var(--game)"> JUEGOS</button>
                <button onclick="nav('folderTasks')" class="btn" style="background:var(--task)"> TAREAS</button>
                <button onclick="nav('folderSocial')" class="btn" style="background: #95a5a6;"> REDES SOCIALES</button>
                <hr style="border: 0.5px solid #333; margin: 15px 0;">
                <button onclick="checkWalletNav()" class="btn btn-gold"> VINCULAR WALLET</button>
                <button onclick="mostrarMiLink()" class="btn" style="background:#34495e;"> INVITAR AMIGOS</button>
                <div class="balance-card">
                    <span style="font-size: 12px;">TU SALDO</span>
                    <div style="font-size: 26px; font-weight: bold; color: var(--primary);"><span id="coinCount">0</span> Υ</div>
                </div>
            </div>
        </div>

        <div id="screenPlayer" class="screen">
            <div class="panel">
                <h3 id="misionTitle">Misi贸n en curso</h3>
                <div id="video-placeholder"></div>
                
                <button id="btnInteractYoutube" class="btn btn-yt-interact">ABRIR YOUTUBE PARA INTERACTUAR</button>
                
                <p style="font-size: 10px; color: var(--gold); margin-bottom: 15px;">锔 隆Dale LIKE, COMENTA y COMPARTE en YouTube! Luego, sube una captura.</p>
                
                <button id="btnUploadProof" onclick="nav('screenUploadProof')" class="btn btn-upload" style="display:none;">SUBIR CAPTURA Y VALIDAR</button>

                <p style="font-size: 11px; margin-top: 10px;">Completadas: <span id="missionsCompletedCount">0</span></p>
                <button onclick="pararMision()" class="btn btn-back">CANCELAR Y VOLVER</button>
            </div>
        </div>

        <div id="screenUploadProof" class="screen">
            <div class="panel">
                <h3>Verificaci贸n de Tarea</h3>
                <p style="font-size: 12px; margin-bottom: 15px;">Sube tu captura de pantalla de la interacci贸n en YouTube. Nuestra IA la revisar谩.</p>
                <input type="file" id="proofImage" accept="image/*">
                <button onclick="validarCaptura()" class="btn btn-green">ENVIAR PARA VALIDAR</button>
                <button onclick="nav('screenPlayer')" class="btn btn-back">VOLVER</button>
            </div>
        </div>

        <div id="folderMusic" class="screen">
            <div class="panel">
                <h3>Buscador de M煤sica</h3>
                <input type="text" id="musicSearch" placeholder="Nombre de la canci贸n..." onkeyup="filtrarMusica()">
                <div id="listaMusica">
                    <button onclick="cargarMision('HL9VoQ-er_U', 5, 'Beele M煤sica')" class="btn btn-music">REPRODUCIR (+5 Υ)</button>
                    </div>
                <button onclick="nav('screenMenu')" class="btn btn-back">VOLVER</button>
            </div>
        </div>

        <div id="folderVideo" class="screen"><div class="panel"><h3>Videos Virales</h3><button onclick="cargarMision('wC_sOpQjvWE', 10, 'Video Beele')" class="btn btn-video">VER VIDEO (+10 Υ)</button><button onclick="nav('screenMenu')" class="btn btn-back">VOLVER</button></div></div>
        <div id="folderSocial" class="screen"><div class="panel"><h3>Redes</h3><button onclick="window.open('https://t.me/TuCanal')" class="btn" style="background:#0088cc">Telegram</button><button onclick="nav('screenMenu')" class="btn btn-back">VOLVER</button></div></div>
        <div id="folderGames" class="screen"><div class="panel"><h3>Juegos</h3><p>Pr贸ximamente...</p><button onclick="nav('screenMenu')" class="btn btn-back">VOLVER</button></div></div>
        <div id="folderTasks" class="screen"><div class="panel"><h3>Tareas</h3><p>Pr贸ximamente...</p><button onclick="nav('screenMenu')" class="btn btn-back">VOLVER</button></div></div>
        <div id="screenWallet" class="screen"><div class="panel"><h3>Vincular</h3><input type="text" id="regName" placeholder="Usuario"><button onclick="vincularWallet()" class="btn btn-green">VINCULAR</button><button onclick="nav('screenMenu')" class="btn btn-back">VOLVER</button></div></div>

    </div>

    <script>
        const SUPABASE_URL = 'https://ywkcnxhlptqagwxjnygx.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Pp5vR4_C_8FPhgrFItKpPQ_gt6f6z3k';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let player, lastTime = 0, currentPoints = 0, coins = 0, walletLinked = false, userName = "";
        let currentVideoId = ""; // Para guardar el ID del video actual
        let missionsCompleted = 0; // Contador de misiones completadas
        
        const urlParams = new URLSearchParams(window.location.search);
        let telegramID = urlParams.get('ref') || "User_" + Math.floor(Math.random() * 9999);

        const msgs = [
            "隆Incre铆ble! Cada huesito ayuda a un animal sin hogar y personas necesitadas.",
            "隆Misi贸n cumplida! Tu apoyo nos ayuda a seguir impactando vidas."
        ];

        function nav(id) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'flex';
        }

        // LGICA DE YOUTUBE ANTITRAMPA Y CARGA DE MISIN
        function cargarMision(videoId, pts, titulo) {
            currentVideoId = videoId; // Guardar el ID del video actual
            currentPoints = pts;
            document.getElementById('misionTitle').innerText = titulo;
            
            // Configurar bot贸n "INTERACTA EN YOUTUBE"
            document.getElementById('btnInteractYoutube').onclick = () => window.open(`https://www.youtube.com/watch?v=${videoId}`, '_blank');
            document.getElementById('btnUploadProof').style.display = 'none'; // Ocultar el bot贸n de subir captura al inicio

            nav('screenPlayer');
            if (player) player.loadVideoById(videoId);
            else player = new YT.Player('video-placeholder', {
                height: '100%', width: '100%', videoId: videoId,
                playerVars: { 'autoplay': 1, 'controls': 1, 'rel': 0 },
                events: { 'onStateChange': onPlayerStateChange }
            });
            lastTime = 0;
            iniciarChequeo();
        }

        function iniciarChequeo() {
            const check = setInterval(() => {
                if (!player || player.getPlayerState() !== 1) return; // Si no est谩 reproduciendo, no hacer nada
                let cur = player.getCurrentTime();
                if (cur > lastTime + 2.5) { 
                    player.seekTo(lastTime); 
                    alert("锔 No adelantes el video. Debes verlo completo para que tu ayuda cuente."); 
                }
                lastTime = cur;
                if (document.getElementById('screenPlayer').style.display === 'none') clearInterval(check);
            }, 1000);
        }

        function onPlayerStateChange(e) {
            if (e.data === YT.PlayerState.ENDED) {
                document.getElementById('btnInteractYoutube').style.display = 'none'; // Ocultar interactuar
                document.getElementById('btnUploadProof').style.display = 'block'; // Mostrar bot贸n de subir captura
                alert("隆Video visto! Ahora, sube la captura de tus interacciones en YouTube.");
            }
        }

        // SIMULACIN DE VALIDACIN POR IA (requiere backend real para IA)
        async function validarCaptura() {
            const fileInput = document.getElementById('proofImage');
            if (fileInput.files.length === 0) {
                alert("Por favor, selecciona una imagen.");
                return;
            }

            // Aqu铆 ir铆a la l贸gica real para enviar la imagen a un servidor con IA
            // Por ahora, simularemos una validaci贸n exitosa.
            alert("Subiendo captura para validaci贸n... (Esto es una simulaci贸n)");

            // Simular un tiempo de procesamiento de IA
            await new Promise(resolve => setTimeout(resolve, 3000)); 

            // Simular resultado de IA
            const iaApproved = Math.random() > 0.2; // 80% de chance de aprobaci贸n en la simulaci贸n

            if (iaApproved) {
                coins += currentPoints;
                document.getElementById('coinCount').innerText = coins;
                missionsCompleted++;
                document.getElementById('missionsCompletedCount').innerText = missionsCompleted;
                alert(msgs[Math.floor(Math.random() * msgs.length)]);
                nav('screenMenu');
                document.getElementById('btnUploadProof').style.display = 'none'; // Ocultar de nuevo
                document.getElementById('btnInteractYoutube').style.display = 'block'; // Mostrar de nuevo
            } else {
                alert("La IA no pudo verificar las interacciones. Por favor, aseg煤rate de dar Like, Comentar y Compartir, y sube una captura clara. Intenta de nuevo.");
                nav('screenPlayer'); // Volver a la pantalla del reproductor
                document.getElementById('btnUploadProof').style.display = 'block'; // Mantener bot贸n visible
            }
            fileInput.value = ''; // Limpiar el input de archivo
        }

        function filtrarMusica() {
            let input = document.getElementById('musicSearch').value.toLowerCase();
            let btns = document.getElementById('listaMusica').getElementsByTagName('button');
            for (let b of btns) b.style.display = b.innerText.toLowerCase().includes(input) ? "block" : "none";
        }

        function mostrarMiLink() {
            if (!walletLinked) { alert("Vincula tu wallet primero para obtener tu link de invitaci贸n."); nav('screenWallet'); return; }
            const link = window.location.origin + window.location.pathname + "?ref=" + (userName || telegramID);
            navigator.clipboard.writeText(link);
            alert("隆Link de invitado copiado!");
        }

        async function vincularWallet() {
            const n = document.getElementById('regName').value;
            if (n) { 
                const { error } = await _supabase.from('usuarios_registrados').insert([{ nombre_usuario: n, monedas: coins }]);
                if (!error) { 
                    walletLinked = true; 
                    userName = n; 
                    alert("隆xito! Wallet vinculada."); 
                    nav('screenMenu'); 
                } else alert("Error al vincular: " + error.message);
            } else alert("Por favor, ingresa un nombre de usuario.");
        }

        function checkWalletNav() { if (!walletLinked) nav('screenWallet'); else alert("Ya tienes una wallet vinculada."); }
        function pararMision() { if(player) player.stopVideo(); nav('screenMenu'); }
    </script>
</body>
</html>
